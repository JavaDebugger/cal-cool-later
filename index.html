<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Calculator container -->
    <div class="calculator">
        <!-- Toast Container positioned relative to calculator -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Calculator header with logo and title -->
        <div class="calculator-header">
            <!-- Help button for opening help modal -->
            <button class="help-icon" onclick="openHelpModal()" title="Help">?</button>
            <!-- Center section with logo and title -->
            <div class="header-center">
                <div class="calculator-logo">
                    <img src="public/images/main-logo-use.svg" alt="Main App Logo" />
                </div>
                <h4 class="calculator-title">Divide & Conquer</h4>
            </div>
        </div>

        <!-- Calculator display screen -->
        <div id="inputBox" class="display">0</div>

        <!-- Calculator button grid -->
        <div class="buttons">
            <!-- Number input buttons -->
            <button class="btn number" onclick="digitBtnPressed('7')">7</button>
            <button class="btn number" onclick="digitBtnPressed('8')">8</button>
            <button class="btn number" onclick="digitBtnPressed('9')">9</button>
            <!-- Basic arithmetic operators -->
            <button class="btn operator" onclick="digitBtnPressed('*')">X</button>

            <!-- Number input buttons -->
            <button class="btn number" onclick="digitBtnPressed('4')">4</button>
            <button class="btn number" onclick="digitBtnPressed('5')">5</button>
            <button class="btn number" onclick="digitBtnPressed('6')">6</button>
            <!-- Basic arithmetic operators -->
            <button class="btn operator" onclick="digitBtnPressed('-')">-</button>

            <!-- Number input buttons -->
            <button class="btn number" onclick="digitBtnPressed('1')">1</button>
            <button class="btn number" onclick="digitBtnPressed('2')">2</button>
            <button class="btn number" onclick="digitBtnPressed('3')">3</button>
            <!-- Basic arithmetic operators -->
            <button class="btn operator" onclick="digitBtnPressed('+')">+</button>

            <!-- Calculator control buttons -->
            <button class="btn clear" onclick="clearDisplay()">AC</button>
            <!-- Number input buttons -->
            <button class="btn number zero" onclick="digitBtnPressed('0')">0</button>
            <button class="btn number" onclick="digitBtnPressed('.')">.</button>
            <!-- Basic arithmetic operators -->
            <button class="btn operator" onclick="digitBtnPressed('/')">/</button>

            <!-- Special function buttons for area/radius calculations -->
            <button class="btn special" onclick="specialBtnPressed('L')">L</button>
            <button class="btn special" onclick="specialBtnPressed('B')">B</button>
            <button class="btn special" onclick="specialBtnPressed('C')">C</button>
            <button class="btn special" onclick="specialBtnPressed('A')">A</button>

            <!-- Calculator control buttons -->
            <button class="btn equals" onclick="calculate()">=</button>
            <button class="btn history" onclick="toggleHistory()">Hist</button>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="modal-overlay">
            <div class="history-modal">
                <div class="modal-header">
                    <div class="modal-header-center">
                        <div class="modal-logo">
                            <img src="public/images/main-logo-use.svg" alt="Main App Logo" />
                        </div>
                        <h2 class="modal-title">Calculation History</h2>
                    </div>
                    <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div id="historyRecords" class="history-records">
                        <!-- History records will be populated here -->
                    </div>
                    <button class="clear-history-btn" onclick="clearHistory()">Clear All History</button>
                    <div id="toastMessage" class="toast-message">
                        History will appear here when available
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal-overlay">
            <div class="help-modal">
                <div class="modal-header">
                    <div class="modal-header-center">
                        <div class="modal-logo">
                            <img src="public/images/main-logo-use.svg" alt="Main App Logo" />
                        </div>
                        <h2 class="modal-title">Calculator Help</h2>
                    </div>
                    <button class="close-btn" onclick="closeHelpModal()">&times;</button>
                </div>
                <div class="help-content">
                    <div class="help-section">
                        <h3>Basic Functions</h3>
                        <div class="function-item">
                            <div class="function-name">Numbers (0-9)</div>
                            <div class="function-desc">Enter numeric values for calculations</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Basic Operators (+, -, ×, ÷)</div>
                            <div class="function-desc">Perform addition, subtraction, multiplication, and division</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">AC (All Clear)</div>
                            <div class="function-desc">Clears the display and resets the calculator</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">= (Equals)</div>
                            <div class="function-desc">Calculates and displays the result</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Hist (History)</div>
                            <div class="function-desc">Opens calculation history with restore functionality</div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Special Functions (LBCA)</h3>
                        <div class="function-item">
                            <div class="function-name">L (Length)</div>
                            <div class="function-desc">Sets the length value for area calculation</div>
                            <div class="formula">Usage: Enter length value, press L</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">B (Breadth)</div>
                            <div class="function-desc">Sets the breadth value for area calculation</div>
                            <div class="formula">Usage: After L, enter breadth value, press B</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">C (Circumference to Radius)</div>
                            <div class="function-desc">Converts circumference to radius</div>
                            <div class="formula">Formula: r = C ÷ (2π)</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">A (Area to Radius)</div>
                            <div class="function-desc">Converts circular area to radius</div>
                            <div class="formula">Formula: r = √(A ÷ π)</div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Formulas Used</h3>
                        <div class="function-item">
                            <div class="function-name">Rectangle Area</div>
                            <div class="formula">Area = Length × Breadth</div>
                            <div class="function-desc">Result displayed in square meters (sq m)</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Circumference to Radius</div>
                            <div class="formula">r = C ÷ (2 × 3.14159)</div>
                            <div class="function-desc">Where π = 3.14159</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Area to Radius</div>
                            <div class="formula">r = √(A ÷ 3.14159)</div>
                            <div class="function-desc">Square root of area divided by π</div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Keyboard Shortcuts & Button Mapping</h3>

                        <h4 class="help-section-header">Basic Input</h4>
                        <div class="function-item">
                            <div class="function-name">Numbers (0-9)</div>
                            <div class="function-desc">Type any number key to input digits</div>
                            <div class="formula">Also supports Numpad0 through Numpad9</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Decimal Point (.)</div>
                            <div class="function-desc">Add decimal point to numbers</div>
                            <div class="formula">Key: Period (.) or NumpadDecimal</div>
                        </div>

                        <h4 class="help-section-header">Operators</h4>
                        <div class="function-item">
                            <div class="function-name">Addition (+)</div>
                            <div class="function-desc">Perform addition operations</div>
                            <div class="formula">Key: Plus (+) or NumpadAdd</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Subtraction (-)</div>
                            <div class="function-desc">Perform subtraction operations</div>
                            <div class="formula">Key: Minus (-) or NumpadSubtract</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Multiplication (×)</div>
                            <div class="function-desc">Perform multiplication operations</div>
                            <div class="formula">Key: Asterisk (*) or NumpadMultiply</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Division (÷)</div>
                            <div class="function-desc">Perform division operations</div>
                            <div class="formula">Key: Forward slash (/) or NumpadDivide</div>
                        </div>

                        <h4 class="help-section-header">Functions</h4>
                        <div class="function-item">
                            <div class="function-name">Calculate (=)</div>
                            <div class="function-desc">Execute calculation and show result</div>
                            <div class="formula">Key: Enter or NumpadEnter</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Clear (AC)</div>
                            <div class="function-desc">Clear display and reset calculator</div>
                            <div class="formula">Key: Escape or C</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Backspace</div>
                            <div class="function-desc">Delete last entered digit</div>
                            <div class="formula">Key: Backspace (clears all if only one digit)</div>
                        </div>

                        <h4 class="help-section-header">Special Functions</h4>
                        <div class="function-item">
                            <div class="function-name">Length (L)</div>
                            <div class="function-desc">Set length value for area calculation</div>
                            <div class="formula">Key: L (after entering a number)</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Breadth (B)</div>
                            <div class="function-desc">Set breadth value for area calculation</div>
                            <div class="formula">Key: B (after setting length and entering breadth)</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Circumference (C)</div>
                            <div class="function-desc">Convert circumference to radius</div>
                            <div class="formula">Key: C (after entering circumference value)</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Area to Radius (A)</div>
                            <div class="function-desc">Convert circular area to radius</div>
                            <div class="formula">Key: A (after entering area value)</div>
                        </div>

                        <h4 class="help-section-header">Navigation</h4>
                        <div class="function-item">
                            <div class="function-name">History Modal</div>
                            <div class="function-desc">Open calculation history</div>
                            <div class="formula">Key: H</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Help Modal</div>
                            <div class="function-desc">Open this help guide</div>
                            <div class="formula">Key: Ctrl + ? or Shift + /</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Close Modals</div>
                            <div class="function-desc">Close any open modal</div>
                            <div class="formula">Key: Escape</div>
                        </div>

                        <h4 class="help-section-header">Mobile Touch Alternatives</h4>
                        <div class="function-item">
                            <div class="function-name">Help Modal</div>
                            <div class="function-desc">Long press help icon (800ms)</div>
                            <div class="formula">Touch and hold the ? button</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">History Modal</div>
                            <div class="function-desc">Double tap calculator display</div>
                            <div class="formula">Quickly tap the display area twice</div>
                        </div>

                        <h4 class="help-section-header">Visual Feedback</h4>
                        <div class="function-item">
                            <div class="function-name">Button Highlighting</div>
                            <div class="function-desc">Buttons light up when pressed via keyboard</div>
                            <div class="formula">Visual confirmation of keyboard input</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Toast Notifications</div>
                            <div class="function-desc">Action confirmations appear at bottom</div>
                            <div class="formula">Success, error, and info messages</div>
                        </div>
                        <div class="function-item">
                            <div class="function-name">Cross-Platform Support</div>
                            <div class="function-desc">Works on QWERTY, AZERTY, and other layouts</div>
                            <div class="formula">Case-insensitive letter keys supported</div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Developer Information</h3>
                        <div class="dev-info">
                            <div class="company-logo">
                                <img src="public/images/nanitech-logo.svg" alt="NaniTech Logo" />
                            </div>
                            <div class="dev-name">Project Phaki Krwele</div>
                            <div class="company-name">Dev company NaniTech</div>

                            <div class="contributors-section">
                                <div class="contributors-title">Contributors</div>
                                <div class="contributors-grid">
                                    <div class="contributor-item">
                                        <div class="contributor-logo">
                                            <img src="public/images/contributor1-logo.svg" alt="IT Varsity" />
                                        </div>
                                        <div class="contributor-name">IT Varsity</div>
                                    </div>
                                    <div class="contributor-item">
                                        <div class="contributor-logo">
                                            <img src="public/images/contributor2-logo.svg" alt="FNB App Academy" />
                                        </div>
                                        <div class="contributor-name">FNB App Academy</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentInput = '0';
        let shouldResetDisplay = false;
        let calculationMode = 'normal'; // 'normal', 'area', 'circumference', 'area_to_radius'
        let areaLength = null;
        let areaBreadth = null;
        const PI = 3.14159;

        // Load history from localStorage
        function loadHistory() {
            const history = localStorage.getItem('calculatorHistory');
            return history ? JSON.parse(history) : [];
        }

        // Save history to localStorage
        function saveHistory(history) {
            localStorage.setItem('calculatorHistory', JSON.stringify(history));
        }

        // Add calculation to history
        function addToHistory(expression, result) {
            const history = loadHistory();
            const timestamp = new Date().toLocaleString();
            history.unshift({ expression, result, timestamp });

            // Keep only last 50 calculations
            if (history.length > 50) {
                history.splice(50);
            }

            saveHistory(history);
        }

        function digitBtnPressed(button) {
            console.log('digitBtnPressed called with:', button); // Enhanced debug log
            const display = document.getElementById("inputBox");

            if (shouldResetDisplay) {
                currentInput = '';
                shouldResetDisplay = false;
                calculationMode = 'normal';
                areaLength = null;
                areaBreadth = null;
            }

            // Handle decimal point properly
            if (button === '.') {
                // Prevent multiple decimal points in the same number
                const parts = currentInput.split(/[\+\-\*\/]/);
                const lastPart = parts[parts.length - 1];
                if (lastPart.includes('.')) {
                    return; // Don't add another decimal point
                }
                if (currentInput === '0') {
                    currentInput = '0.';
                } else {
                    currentInput += '.';
                }
            } else if (currentInput === '0' && button !== '.') {
                currentInput = button;
            } else {
                currentInput += button;
            }

            display.textContent = currentInput;
            console.log('Input updated:', currentInput); // Debug log
        }

        function specialBtnPressed(button) {
            const display = document.getElementById("inputBox");
            console.log('Special button pressed:', button, 'Current input:', currentInput); // Debug log

            if (shouldResetDisplay) {
                currentInput = '';
                shouldResetDisplay = false;
            }

            if (button === 'L') {
                // Length button for area calculation
                // Extract the last number from the current input
                const lastNumber = extractLastNumber(currentInput);
                console.log('Extracted last number for L:', lastNumber); // Debug log

                if (lastNumber && !isNaN(lastNumber) && parseFloat(lastNumber) > 0) {
                    areaLength = parseFloat(lastNumber);
                    calculationMode = 'area';
                    currentInput += ' L';
                    display.textContent = currentInput;
                    console.log('Length set:', areaLength); // Debug log
                } else {
                    showError("Error: Invalid length", display);
                }
            } else if (button === 'B') {
                // Breadth button for area calculation
                if (calculationMode === 'area' && currentInput.includes('L')) {
                    // Extract the breadth value (number after the last operator)
                    const lastNumber = extractLastNumber(currentInput.replace(/ L/g, ''));
                    console.log('Extracted last number for B:', lastNumber); // Debug log

                    if (lastNumber && !isNaN(lastNumber) && parseFloat(lastNumber) > 0) {
                        areaBreadth = parseFloat(lastNumber);
                        currentInput += ' B';
                        display.textContent = currentInput;
                        console.log('Breadth set:', areaBreadth); // Debug log
                    } else {
                        showError("Error: Invalid breadth", display);
                    }
                } else {
                    showError("Error: Press L first", display);
                }
            } else if (button === 'C') {
                // Circumference to radius
                const value = parseFloat(currentInput);
                console.log('Circumference value:', value); // Debug log

                if (!isNaN(value) && value > 0) {
                    calculationMode = 'circumference';
                    currentInput += ' C';
                    display.textContent = currentInput;
                } else {
                    showError("Error: Invalid circumference", display);
                }
            } else if (button === 'A') {
                // Area to radius
                const value = parseFloat(currentInput);
                console.log('Area value:', value); // Debug log

                if (!isNaN(value) && value > 0) {
                    calculationMode = 'area_to_radius';
                    currentInput += ' A';
                    display.textContent = currentInput;
                } else {
                    showError("Error: Invalid area", display);
                }
            }
        }

        // Helper function to extract the last number from an expression
        function extractLastNumber(expression) {
            const parts = expression.split(/[\+\-\*\/]/);
            const lastPart = parts[parts.length - 1].trim();
            return lastPart;
        }

        // Helper function to show error messages
        function showError(message, display) {
            const originalText = currentInput;
            display.textContent = message;
            setTimeout(() => {
                display.textContent = originalText;
            }, 1500);
        }

        // Comprehensive Toast Notification System
        function showToast(message, type = 'info', duration = 3000) {
            try {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    console.warn('Toast container not found');
                    return;
                }

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;

                toastContainer.appendChild(toast);

                // Trigger show animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Auto remove toast
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);

            } catch (error) {
                console.error('Toast notification error:', error);
            }
        }

        // Visual feedback for keyboard shortcuts
        function highlightButton(buttonText, duration = 200) {
            try {
                // Find button by text content
                const buttons = document.querySelectorAll('.btn');
                let targetButton = null;

                for (let button of buttons) {
                    if (button.textContent.trim() === buttonText) {
                        targetButton = button;
                        break;
                    }
                }

                if (targetButton) {
                    targetButton.classList.add('keyboard-active');
                    setTimeout(() => {
                        targetButton.classList.remove('keyboard-active');
                    }, duration);
                }
            } catch (error) {
                console.error('Button highlight error:', error);
            }
        }

        // Enhanced keyboard mapping helper functions
        function isNumpadKey(key) {
            return /^Numpad[0-9]$/.test(key);
        }

        function getNumpadValue(key) {
            return key.replace('Numpad', '');
        }

        function isValidLetterKey(key) {
            return /^[a-zA-Z]$/.test(key) && key.length === 1;
        }

        // Mobile touch optimization helpers
        function addMobileTouchSupport() {
            if ('ontouchstart' in window) {
                // Add long-press gesture for help modal
                let helpPressTimer;
                const helpIcon = document.querySelector('.help-icon');

                if (helpIcon) {
                    helpIcon.addEventListener('touchstart', (e) => {
                        helpPressTimer = setTimeout(() => {
                            openHelpModal();
                            showToast('Help modal opened via long press', 'info');
                        }, 800);
                    });

                    helpIcon.addEventListener('touchend', () => {
                        clearTimeout(helpPressTimer);
                    });

                    helpIcon.addEventListener('touchmove', () => {
                        clearTimeout(helpPressTimer);
                    });
                }

                // Add double-tap for history on calculator display
                let lastTap = 0;
                const display = document.getElementById('inputBox');

                if (display) {
                    display.addEventListener('touchend', (e) => {
                        const currentTime = new Date().getTime();
                        const tapLength = currentTime - lastTap;

                        if (tapLength < 500 && tapLength > 0) {
                            e.preventDefault();
                            toggleHistory();
                            showToast('History opened via double tap', 'info');
                        }
                        lastTap = currentTime;
                    });
                }
            }
        }

        function clearDisplay() {
            currentInput = '0';
            document.getElementById("inputBox").textContent = currentInput;
            shouldResetDisplay = false;
            calculationMode = 'normal';
            areaLength = null;
            areaBreadth = null;
        }

        function calculate() {
            const display = document.getElementById("inputBox");
            let result;
            let expression = currentInput;

            console.log('Calculate called with:', currentInput, 'Mode:', calculationMode); // Debug log

            try {
                if (calculationMode === 'area' && areaLength !== null && currentInput.includes('L') && currentInput.includes('B')) {
                    // Area calculation: Length × Breadth
                    console.log('Area calculation - Length:', areaLength, 'Breadth:', areaBreadth); // Debug log

                    if (areaBreadth !== null) {
                        result = areaLength * areaBreadth;
                        const resultText = result + ' sq m';
                        const fullExpression = currentInput + ' = ' + resultText;

                        display.textContent = fullExpression;
                        addToHistory(currentInput, resultText);
                        currentInput = result.toString();
                        shouldResetDisplay = true;
                        resetCalculationState();
                        return;
                    } else {
                        showError("Error: Missing breadth", display);
                        return;
                    }
                } else if (calculationMode === 'circumference' && currentInput.includes(' C')) {
                    // Circumference to radius: r = C ÷ (2π)
                    const circumference = parseFloat(currentInput.replace(' C', ''));
                    console.log('Circumference calculation:', circumference); // Debug log

                    result = circumference / (2 * PI);
                    result = Math.round(result * 100) / 100; // Round to 2 decimal places
                    const resultText = result + ' r';
                    const fullExpression = currentInput + ' = ' + resultText;

                    display.textContent = fullExpression;
                    addToHistory(currentInput, resultText);
                    currentInput = result.toString();
                    shouldResetDisplay = true;
                    resetCalculationState();
                    return;
                } else if (calculationMode === 'area_to_radius' && currentInput.includes(' A')) {
                    // Area to radius: r = √(A ÷ π)
                    const area = parseFloat(currentInput.replace(' A', ''));
                    console.log('Area to radius calculation:', area); // Debug log

                    if (area < 0) {
                        showError("Error: Negative area", display);
                        resetCalculationState();
                        return;
                    }
                    result = Math.sqrt(area / PI);
                    result = Math.round(result * 100) / 100; // Round to 2 decimal places
                    const resultText = result + ' r';
                    const fullExpression = currentInput + ' = ' + resultText;

                    display.textContent = fullExpression;
                    addToHistory(currentInput, resultText);
                    currentInput = result.toString();
                    shouldResetDisplay = true;
                    resetCalculationState();
                    return;
                } else {
                    // Standard arithmetic calculation
                    let cleanExpression = currentInput.replace(/X/g, '*').replace(/÷/g, '/');

                    // Remove any special notation that might have been added
                    cleanExpression = cleanExpression.replace(/ [LBCA]/g, '');
                    console.log('Standard calculation:', cleanExpression); // Debug log

                    // Basic validation to prevent dangerous eval
                    if (/^[0-9+\-*/.() ]+$/.test(cleanExpression)) {
                        result = eval(cleanExpression);

                        // Handle division by zero and other edge cases
                        if (!isFinite(result)) {
                            showError("Error: Invalid result", display);
                            resetCalculationState();
                        } else {
                            // Round to avoid floating point precision issues
                            result = Math.round(result * 100000000) / 100000000;
                            const resultText = result.toString();
                            const fullExpression = currentInput + ' = ' + resultText;

                            display.textContent = fullExpression;
                            addToHistory(currentInput, resultText);
                            currentInput = resultText;
                            shouldResetDisplay = true;
                        }
                    } else {
                        showError("Error: Invalid expression", display);
                        resetCalculationState();
                    }
                }
            } catch (error) {
                console.error('Calculation error:', error); // Debug log
                showError("Error: Calculation failed", display);
                resetCalculationState();
            }
        }

        // Helper function to reset calculation state
        function resetCalculationState() {
            calculationMode = 'normal';
            areaLength = null;
            areaBreadth = null;
            currentInput = '0';
            shouldResetDisplay = true;
        }
        // History Modal functions
        function toggleHistory() {
            openHistoryModal();
        }

        function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            const historyModal = modal.querySelector('.history-modal');

            displayHistory();
            modal.style.display = 'flex';

            // Trigger animations
            setTimeout(() => {
                modal.classList.add('show');
                historyModal.classList.add('show');
            }, 10);

            // Focus management for accessibility
            modal.querySelector('.close-btn').focus();

            // Add click-outside-to-close functionality
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeHistoryModal();
                }
            });
        }

        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            const historyModal = modal.querySelector('.history-modal');

            // Remove show classes to trigger exit animations
            modal.classList.remove('show');
            historyModal.classList.remove('show');

            // Hide modal after animation completes
            setTimeout(() => {
                modal.style.display = 'none';
            }, 900);
        }

        function displayHistory() {
            const history = loadHistory();
            const historyRecords = document.getElementById('historyRecords');
            const toastMessage = document.getElementById('toastMessage');

            if (history.length === 0) {
                historyRecords.innerHTML = '';
                toastMessage.style.display = 'block';
                return;
            }

            toastMessage.style.display = 'none';

            // Display only the 10 most recent records
            const recentHistory = history.slice(0, 10);

            historyRecords.innerHTML = recentHistory.map((item, index) => {
                // Ensure we have clean data for both display and restore functionality
                const cleanExpression = item.expression.replace(/<[^>]*>/g, '');
                const cleanResult = item.result.replace(/<[^>]*>/g, '');

                // Format the display text with proper spacing
                const displayText = formatHistoryDisplay(cleanExpression, cleanResult);

                return `<div class="history-record">
                    <div class="record-content">
                        <div class="record-expression">${displayText}</div>
                        <div class="record-timestamp">${item.timestamp}</div>
                    </div>
                    <button class="restore-btn" onclick="restoreCalculation('${escapeQuotes(cleanExpression)}', '${escapeQuotes(cleanResult)}')">Restore</button>
                </div>`;
            }).join('');
        }

        function formatHistoryDisplay(expression, result) {
            // Clean both expression and result of any HTML tags
            const cleanExpression = expression.replace(/<[^>]*>/g, '');
            const cleanResult = result.replace(/<[^>]*>/g, '');

            // Add proper spacing around operators for better readability
            const formattedExpression = cleanExpression
                .replace(/([+\-*/÷X])/g, ' $1 ')  // Add spaces around operators
                .replace(/\s+/g, ' ')              // Clean up multiple spaces
                .trim();                           // Remove leading/trailing spaces

            // Combine expression and result with proper spacing
            return `${formattedExpression} = ${cleanResult}`;
        }

        function escapeQuotes(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function restoreCalculation(expression, result) {
            // Remove any HTML formatting tags and restore the original expression
            const cleanExpression = expression.replace(/<[^>]*>/g, '');
            currentInput = cleanExpression;
            document.getElementById("inputBox").textContent = currentInput;
            closeHistoryModal();
            shouldResetDisplay = false;
        }

        function clearHistory() {
            localStorage.removeItem('calculatorHistory');
            displayHistory();
        }

        // Help Modal functions
        function openHelpModal() {
            const modal = document.getElementById('helpModal');
            const helpModal = modal.querySelector('.help-modal');

            modal.style.display = 'flex';

            // Trigger animations
            setTimeout(() => {
                modal.classList.add('show');
                helpModal.classList.add('show');
            }, 10);

            // Focus management for accessibility
            modal.querySelector('.close-btn').focus();

            // Add click-outside-to-close functionality
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeHelpModal();
                }
            });
        }

        function closeHelpModal() {
            const modal = document.getElementById('helpModal');
            const helpModal = modal.querySelector('.help-modal');

            // Remove show classes to trigger exit animations
            modal.classList.remove('show');
            helpModal.classList.remove('show');

            // Hide modal after animation completes
            setTimeout(() => {
                modal.style.display = 'none';
            }, 900);
        }

        // Comprehensive Keyboard Support System
        document.addEventListener('keydown', function(event) {
            try {
                const key = event.key;
                const code = event.code;
                const historyModal = document.getElementById('historyModal');
                const helpModal = document.getElementById('helpModal');
                const isHistoryModalOpen = historyModal && historyModal.style.display === 'flex';
                const isHelpModalOpen = helpModal && helpModal.style.display === 'flex';

                // If any modal is open, handle modal-specific keys
                if (isHistoryModalOpen || isHelpModalOpen) {
                    if (key === 'Escape') {
                        if (isHistoryModalOpen) {
                            closeHistoryModal();
                            showToast('History modal closed', 'info', 2000);
                        } else if (isHelpModalOpen) {
                            closeHelpModal();
                            showToast('Help modal closed', 'info', 2000);
                        }
                        return;
                    }
                    // Prevent other calculator keys when modal is open
                    return;
                }

                // Handle number keys (both main keyboard and numpad)
                if ((key >= '0' && key <= '9') || isNumpadKey(code)) {
                    const digit = isNumpadKey(code) ? getNumpadValue(code) : key;
                    digitBtnPressed(digit);
                    highlightButton(digit);
                    return;
                }

                // Handle basic operators
                if (key === '+') {
                    digitBtnPressed('+');
                    highlightButton('+');
                    return;
                } else if (key === '-') {
                    digitBtnPressed('-');
                    highlightButton('-');
                    return;
                } else if (key === '*' || key.toLowerCase() === 'x') {
                    digitBtnPressed('*');
                    highlightButton('X');
                    return;
                } else if (key === '/' || code === 'NumpadDivide') {
                    event.preventDefault(); // Prevent browser search
                    digitBtnPressed('/');
                    highlightButton('/');
                    return;
                }

                // Handle decimal point
                if (key === '.' || code === 'NumpadDecimal') {
                    digitBtnPressed('.');
                    highlightButton('.');
                    return;
                }

                // Handle calculation execution
                if (key === 'Enter' || key === '=' || code === 'NumpadEnter') {
                    event.preventDefault();
                    calculate();
                    highlightButton('=');
                    showToast('Calculation executed', 'success', 2000);
                    return;
                }

                // Handle clear operations
                if (key === 'Escape' || (key.toLowerCase() === 'c' && !event.shiftKey && !event.ctrlKey)) {
                    clearDisplay();
                    highlightButton('AC');
                    showToast('Calculator cleared', 'info', 2000);
                    return;
                }

                // Handle backspace
                if (key === 'Backspace') {
                    if (currentInput.length > 1) {
                        currentInput = currentInput.slice(0, -1);
                        document.getElementById("inputBox").textContent = currentInput;
                        showToast('Last digit removed', 'info', 1500);
                    } else {
                        clearDisplay();
                        showToast('Calculator cleared', 'info', 2000);
                    }
                    return;
                }

                // Handle special function keys
                if (key.toLowerCase() === 'l' && !event.ctrlKey) {
                    specialBtnPressed('L');
                    highlightButton('L');
                    showToast('Length function activated', 'info', 2000);
                    return;
                } else if (key.toLowerCase() === 'b' && !event.ctrlKey) {
                    specialBtnPressed('B');
                    highlightButton('B');
                    showToast('Breadth function activated', 'info', 2000);
                    return;
                } else if (event.shiftKey && key.toLowerCase() === 'c') {
                    specialBtnPressed('C');
                    highlightButton('C');
                    showToast('Circumference function activated', 'info', 2000);
                    return;
                } else if (event.shiftKey && key.toLowerCase() === 'a') {
                    specialBtnPressed('A');
                    highlightButton('A');
                    showToast('Area function activated', 'info', 2000);
                    return;
                }

                // Handle modal toggles
                if (key.toLowerCase() === 'h' && !event.ctrlKey) {
                    toggleHistory();
                    highlightButton('Hist');
                    showToast('History toggled', 'info', 2000);
                    return;
                } else if ((key === '?' || (event.shiftKey && key === '/')) || (event.ctrlKey && key === '?')) {
                    event.preventDefault();
                    openHelpModal();
                    showToast('Help modal opened', 'info', 2000);
                    return;
                }

                // Handle other letter keys for special functions (A-Z excluding H, C which have special handling)
                if (isValidLetterKey(key) && !event.ctrlKey && !event.altKey) {
                    const upperKey = key.toUpperCase();

                    // Skip keys that already have special handling
                    if (['H', 'C', 'L', 'B', 'A'].includes(upperKey)) {
                        return;
                    }

                    // Check if there's a corresponding button for this letter
                    const buttons = document.querySelectorAll('.btn.special');
                    let foundButton = false;

                    for (let button of buttons) {
                        if (button.textContent.trim() === upperKey) {
                            specialBtnPressed(upperKey);
                            highlightButton(upperKey);
                            showToast(`${upperKey} function activated`, 'info', 2000);
                            foundButton = true;
                            break;
                        }
                    }

                    if (!foundButton) {
                        showToast(`Key '${upperKey}' not mapped to any function`, 'error', 2000);
                    }
                    return;
                }

            } catch (error) {
                console.error('Keyboard event error:', error);
                showToast('Keyboard input error occurred', 'error', 3000);
            }
        });

        // Debug function to test all calculator functions
        function runDebugTests() {
            console.log("=== CALCULATOR DEBUG TESTS ===");
            let testsPassed = 0;
            let totalTests = 0;

            function runTest(testName, testFunction) {
                totalTests++;
                console.log(`\n--- ${testName} ---`);
                try {
                    testFunction();
                    testsPassed++;
                    console.log(`✅ ${testName} PASSED`);
                } catch (error) {
                    console.error(`❌ ${testName} FAILED:`, error);
                }
            }

            // Test 1: Basic number input
            runTest("Basic number input", () => {
                clearDisplay();
                digitBtnPressed('1');
                digitBtnPressed('2');
                digitBtnPressed('3');
                if (currentInput !== '123') throw new Error(`Expected 123, got ${currentInput}`);
                console.log("✓ Number input works correctly");
            });

            // Test 2: Decimal point handling
            runTest("Decimal point handling", () => {
                clearDisplay();
                digitBtnPressed('3');
                digitBtnPressed('.');
                digitBtnPressed('1');
                digitBtnPressed('4');
                if (currentInput !== '3.14') throw new Error(`Expected 3.14, got ${currentInput}`);

                // Test preventing multiple decimal points
                digitBtnPressed('.');
                if (currentInput !== '3.14') throw new Error(`Multiple decimals allowed: ${currentInput}`);
                console.log("✓ Decimal point handling works correctly");
            });

            // Test 3: Basic arithmetic
            runTest("Basic arithmetic", () => {
                clearDisplay();
                digitBtnPressed('5');
                digitBtnPressed('+');
                digitBtnPressed('3');
                calculate();
                const display = document.getElementById("inputBox").textContent;
                if (!display.includes('8')) throw new Error(`Expected result 8, got ${display}`);
                console.log("✓ Basic arithmetic works correctly");
            });

            // Test 4: Area calculation (L × B)
            runTest("Area calculation", () => {
                clearDisplay();
                digitBtnPressed('1');
                digitBtnPressed('0');
                specialBtnPressed('L');
                digitBtnPressed('*');
                digitBtnPressed('5');
                specialBtnPressed('B');
                calculate();
                const display = document.getElementById("inputBox").textContent;
                if (!display.includes('50 sq m')) throw new Error(`Expected 50 sq m, got ${display}`);
                console.log("✓ Area calculation works correctly");
            });

            // Test 5: Circumference to radius
            runTest("Circumference to radius", () => {
                clearDisplay();
                digitBtnPressed('3');
                digitBtnPressed('1');
                digitBtnPressed('.');
                digitBtnPressed('4');
                specialBtnPressed('C');
                calculate();
                const display = document.getElementById("inputBox").textContent;
                if (!display.includes('r')) throw new Error(`Expected radius result, got ${display}`);
                console.log("✓ Circumference to radius works correctly");
            });

            // Test 6: Area to radius
            runTest("Area to radius", () => {
                clearDisplay();
                digitBtnPressed('7');
                digitBtnPressed('8');
                digitBtnPressed('.');
                digitBtnPressed('5');
                specialBtnPressed('A');
                calculate();
                const display = document.getElementById("inputBox").textContent;
                if (!display.includes('r')) throw new Error(`Expected radius result, got ${display}`);
                console.log("✓ Area to radius works correctly");
            });

            // Test 7: Error validation - B without L
            runTest("Error validation - B without L", () => {
                clearDisplay();
                digitBtnPressed('5');
                specialBtnPressed('B');
                setTimeout(() => {
                    const display = document.getElementById("inputBox").textContent;
                    if (!display.includes('Error')) throw new Error(`Expected error message, got ${display}`);
                    console.log("✓ B without L error validation works");
                }, 100);
            });

            // Test 8: Clear display functionality
            runTest("Clear display", () => {
                clearDisplay();
                if (currentInput !== '0') throw new Error(`Expected 0, got ${currentInput}`);
                if (calculationMode !== 'normal') throw new Error(`Mode not reset: ${calculationMode}`);
                console.log("✓ Clear display works correctly");
            });

            // Test 9: Modal functions exist
            runTest("Modal functions", () => {
                if (typeof openHelpModal !== 'function') throw new Error("Help modal function missing");
                if (typeof openHistoryModal !== 'function') throw new Error("History modal function missing");
                if (typeof toggleHistory !== 'function') throw new Error("Toggle history function missing");
                console.log("✓ All modal functions exist");
            });

            // Test 10: History functionality
            runTest("History functionality", () => {
                const historyBefore = loadHistory();
                addToHistory('2+2', '4');
                const historyAfter = loadHistory();
                if (historyAfter.length <= historyBefore.length) {
                    throw new Error("History not saved properly");
                }
                console.log("✓ History functionality works");
            });

            // Test 11: History display formatting
            runTest("History display formatting", () => {
                const testExpression = "0.220L*2.02B";
                const testResult = "0.4444 sq m";
                const formatted = formatHistoryDisplay(testExpression, testResult);
                const expected = "0.220L * 2.02B = 0.4444 sq m";
                if (formatted !== expected) {
                    throw new Error(`Expected "${expected}", got "${formatted}"`);
                }
                console.log("✓ History display formatting works correctly");
            });

            // Test 12: Keyboard mapping helper functions
            runTest("Keyboard mapping helpers", () => {
                if (!isNumpadKey('Numpad5')) throw new Error("Numpad key detection failed");
                if (isNumpadKey('5')) throw new Error("Regular key incorrectly detected as numpad");
                if (getNumpadValue('Numpad7') !== '7') throw new Error("Numpad value extraction failed");
                if (!isValidLetterKey('A')) throw new Error("Letter key validation failed");
                if (isValidLetterKey('1')) throw new Error("Number incorrectly detected as letter");
                console.log("✓ Keyboard mapping helper functions work correctly");
            });

            // Test 13: Toast notification system
            runTest("Toast notification system", () => {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) throw new Error("Toast container not found");

                // Test toast creation (won't actually show in test)
                showToast('Test message', 'info', 1000);
                console.log("✓ Toast notification system works correctly");
            });

            // Summary
            console.log(`\n=== DEBUG TESTS COMPLETE ===`);
            console.log(`Tests passed: ${testsPassed}/${totalTests}`);
            if (testsPassed === totalTests) {
                console.log("🎉 All functions are working correctly!");
                console.log("📋 History display now shows clean, readable calculations!");
                console.log("⌨️ Comprehensive keyboard mapping system is functional!");
                console.log("📱 Mobile touch optimization is ready!");
                console.log("🔔 Toast notification system is operational!");
            } else {
                console.log("⚠️ Some tests failed. Check the logs above.");
            }
        }

        // Enhanced calculator interaction effects
        function addCalculatorEffects() {
            const calculator = document.querySelector('.calculator');
            let idleTimer;

            // Start idle animation after 3 seconds of no interaction
            function startIdleTimer() {
                clearTimeout(idleTimer);
                calculator.classList.remove('idle');
                idleTimer = setTimeout(() => {
                    calculator.classList.add('idle');
                }, 3000);
            }

            // Remove idle animation on interaction
            function stopIdleAnimation() {
                calculator.classList.remove('idle');
                clearTimeout(idleTimer);
            }

            // Add calculating animation
            function triggerCalculatingEffect() {
                calculator.classList.remove('idle');
                calculator.classList.add('calculating');
                setTimeout(() => {
                    calculator.classList.remove('calculating');
                    startIdleTimer();
                }, 600);
            }

            // Enhanced button interaction effects
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('mouseenter', stopIdleAnimation);
                btn.addEventListener('click', () => {
                    stopIdleAnimation();
                    if (btn.classList.contains('equals')) {
                        triggerCalculatingEffect();
                    } else {
                        startIdleTimer();
                    }
                });
            });

            // Calculator hover effects
            calculator.addEventListener('mouseenter', stopIdleAnimation);
            calculator.addEventListener('mouseleave', startIdleTimer);

            // Start the idle timer initially
            startIdleTimer();

            // Override the original calculate function to add effects
            const originalCalculate = window.calculate;
            window.calculate = function() {
                triggerCalculatingEffect();
                return originalCalculate.apply(this, arguments);
            };
        }

        // Initialize display
        document.addEventListener('DOMContentLoaded', function() {
            try {
                clearDisplay();
                addCalculatorEffects();
                addMobileTouchSupport();

                // Add debug button for testing (remove in production)
                const debugBtn = document.createElement('button');
                debugBtn.textContent = 'Debug Tests';
                debugBtn.style.position = 'fixed';
                debugBtn.style.top = '10px';
                debugBtn.style.right = '10px';
                debugBtn.style.zIndex = '9999';
                debugBtn.style.background = '#ff9500';
                debugBtn.style.color = 'white';
                debugBtn.style.border = 'none';
                debugBtn.style.padding = '8px 12px';
                debugBtn.style.borderRadius = '5px';
                debugBtn.style.cursor = 'pointer';
                debugBtn.style.fontSize = '12px';
                debugBtn.style.fontWeight = 'bold';
                debugBtn.onclick = runDebugTests;
                document.body.appendChild(debugBtn);

                // Add keyboard shortcuts info
                const infoBtn = document.createElement('button');
                infoBtn.textContent = 'Shortcuts';
                infoBtn.style.position = 'fixed';
                infoBtn.style.top = '50px';
                infoBtn.style.right = '10px';
                infoBtn.style.zIndex = '9999';
                infoBtn.style.background = '#4a90e2';
                infoBtn.style.color = 'white';
                infoBtn.style.border = 'none';
                infoBtn.style.padding = '8px 12px';
                infoBtn.style.borderRadius = '5px';
                infoBtn.style.cursor = 'pointer';
                infoBtn.style.fontSize = '12px';
                infoBtn.style.fontWeight = 'bold';
                infoBtn.onclick = showKeyboardShortcuts;
                document.body.appendChild(infoBtn);

                // Add keyboard test button
                const testBtn = document.createElement('button');
                testBtn.textContent = 'Test Keys';
                testBtn.style.position = 'fixed';
                testBtn.style.top = '90px';
                testBtn.style.right = '10px';
                testBtn.style.zIndex = '9999';
                testBtn.style.background = '#28a745';
                testBtn.style.color = 'white';
                testBtn.style.border = 'none';
                testBtn.style.padding = '8px 12px';
                testBtn.style.borderRadius = '5px';
                testBtn.style.cursor = 'pointer';
                testBtn.style.fontSize = '12px';
                testBtn.style.fontWeight = 'bold';
                testBtn.onclick = testKeyboardMapping;
                document.body.appendChild(testBtn);

                // Show initialization success
                showToast('Calculator initialized with comprehensive keyboard support!', 'success', 4000);

                console.log('Calculator initialized successfully!');
                console.log('Comprehensive Keyboard Shortcuts:');
                console.log('- Numbers: 0-9 (main keyboard and numpad)');
                console.log('- Operators: +, -, *, / (main keyboard and numpad)');
                console.log('- Multiplication: * or X key');
                console.log('- Division: / (main keyboard and numpad)');
                console.log('- Decimal: . (main keyboard and numpad)');
                console.log('- Calculate: Enter, = (main keyboard and numpad)');
                console.log('- Clear: Escape or C key');
                console.log('- Backspace: Backspace key');
                console.log('- Special functions: L, B, Shift+C, Shift+A');
                console.log('- History: H key');
                console.log('- Help: ? or Shift+/ or Ctrl+?');
                console.log('- Mobile: Long press help icon, double tap display for history');
                console.log('- All letter keys A-Z supported for special functions');

            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Calculator initialization error', 'error', 5000);
            }
        });

        // Test keyboard mapping functionality
        function testKeyboardMapping() {
            console.log("=== KEYBOARD MAPPING TEST ===");

            // Test number keys
            console.log("Testing number keys...");
            for (let i = 0; i <= 9; i++) {
                const event = new KeyboardEvent('keydown', { key: i.toString() });
                document.dispatchEvent(event);
            }

            // Test operator keys
            console.log("Testing operator keys...");
            ['+', '-', '*', '/'].forEach(op => {
                const event = new KeyboardEvent('keydown', { key: op });
                document.dispatchEvent(event);
            });

            // Test special function keys
            console.log("Testing special function keys...");
            ['l', 'b'].forEach(key => {
                const event = new KeyboardEvent('keydown', { key: key });
                document.dispatchEvent(event);
            });

            // Test modal keys
            console.log("Testing modal keys...");
            const hEvent = new KeyboardEvent('keydown', { key: 'h' });
            document.dispatchEvent(hEvent);

            console.log("✅ Keyboard mapping test completed!");
            showToast('Keyboard mapping test completed successfully!', 'success', 3000);
        }

        // Show comprehensive keyboard shortcuts
        function showKeyboardShortcuts() {
            const shortcutsText = `Comprehensive Keyboard Shortcuts:

📱 NUMBERS & BASIC OPERATIONS:
• Numbers: 0-9 (main keyboard and numpad)
• Operators: + - (main keyboard and numpad)
• Multiplication: * or X key
• Division: / (main keyboard and numpad)
• Decimal: . (main keyboard and numpad)
• Calculate: Enter, = (main keyboard and numpad)

🧹 CLEAR & EDIT:
• Clear All: Escape or C key
• Backspace: Backspace key (removes last digit)

🔤 SPECIAL FUNCTIONS:
• Length: L key
• Breadth: B key
• Circumference: Shift+C
• Area to Radius: Shift+A
• All letter keys A-Z supported for special functions

📋 MODALS & NAVIGATION:
• History: H key
• Help: ? or Shift+/ or Ctrl+?
• Close Modal: Escape key

📱 MOBILE TOUCH ALTERNATIVES:
• Help Modal: Long press help icon (800ms)
• History Modal: Double tap calculator display
• All keyboard functions work on touch devices

⚡ VISUAL FEEDBACK:
• Button highlighting on keyboard input
• Toast notifications for actions
• Error handling with user feedback

🌐 CROSS-PLATFORM SUPPORT:
• Works on QWERTY, AZERTY, and other layouts
• Numpad fully supported
• Case-insensitive letter keys`;

            alert(shortcutsText);
            showToast('Keyboard shortcuts displayed', 'info', 2000);
        }
    </script>
</body>
</html>

